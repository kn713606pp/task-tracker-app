<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>協作任務追蹤 App (Phase 2 - 功能完整版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .task-card { 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #6366f1);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.45);
        }
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .tab-active { 
            color: #4338ca; 
            background-color: #eef2ff;
        }
        .tab-inactive { 
            color: #475569;
            background-color: transparent;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #eef2ff;
            border: 2px dashed #6366f1;
        }
        mark {
            background-color: #fef08a;
            padding: 1px 2px;
            border-radius: 3px;
            color: #713f12;
        }
        .ai-btn-enabled {
             background-color: #f0fdfa !important;
             color: #0f766e !important;
             border-color: #ccfbf1 !important;
        }
        .ai-btn-enabled:hover {
             background-color: #ccfbf1 !important;
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-50/80 backdrop-blur-sm flex items-center justify-center z-[9999] transition-opacity duration-300">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-3 text-slate-600 font-medium">正在連線至雲端白板...</p>
        </div>
    </div>
    
    <div id="edit-modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 modal-overlay hidden">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-xl">
             <form id="edit-task-form">
                <div class="p-6 md:p-8">
                    <h2 class="text-xl font-semibold mb-6 text-slate-800">編輯任務</h2>
                    <div class="space-y-5">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="edit-task-category" class="block text-sm font-medium text-slate-600 mb-1.5">任務分類</label>
                                <select id="edit-task-category" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                            </div>
                             <div>
                                <label for="edit-task-due-date" class="block text-sm font-medium text-slate-600 mb-1.5">截止日期</label>
                                <input type="date" id="edit-task-due-date" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                            </div>
                        </div>
                        <div>
                            <label for="edit-task-title" class="block text-sm font-medium text-slate-600 mb-1.5">任務標題</label>
                             <input type="text" id="edit-task-title" placeholder="請輸入任務標題..." class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition" required>
                        </div>
                        <div>
                            <label for="edit-task-desc" class="block text-sm font-medium text-slate-600 mb-1.5">任務描述</label>
                            <textarea id="edit-task-desc" rows="4" placeholder="請輸入任務描述..." class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></textarea>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-6 py-4 flex justify-end items-center space-x-3 rounded-b-xl">
                    <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-white text-slate-700 rounded-md hover:bg-slate-100 transition text-sm font-semibold border border-slate-300">取消</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm font-semibold">儲存變更</button>
                </div>
            </form>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-900 tracking-tight">協作任務追蹤</h1>
            <p class="text-slate-500 mt-3 max-w-lg mx-auto">一個簡潔、高效的平台，讓您的團隊保持同步與專注。</p>
            <div id="offline-status" class="hidden mt-4 text-sm font-semibold text-amber-800 bg-amber-100 p-3 rounded-lg flex items-center justify-center max-w-md mx-auto shadow-sm border border-amber-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>您目前處於離線狀態，所有變更將在恢復連線後自動同步。</div>
        </header>

        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200/50 mb-10">
            <h2 class="text-xl font-semibold mb-6 text-slate-800">新增一項任務</h2>
            <form id="add-task-form" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button type="button" id="ai-inspiration-btn" class="w-full text-sm bg-indigo-50 text-indigo-700 font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-100 transition-all duration-200 flex items-center justify-center shadow-sm border border-indigo-200/50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M11.906 2.006a1.5 1.5 0 00-1.812 0l-7.5 5.25c-.714.5-1.094 1.342-1.094 2.244v4.5a2.5 2.5 0 002.5 2.5h11a2.5 2.5 0 002.5-2.5v-4.5c0-.902-.38-1.744-1.094-2.244l-7.5-5.25z" /><path d="M9 16a1 1 0 002 0v-5a1 1 0 10-2 0v5z" /></svg>
                        AI 任務靈感
                    </button>
                    <button type="button" id="ai-summarize-btn" class="w-full text-sm bg-slate-100 text-slate-500 font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center shadow-sm border border-slate-200/80 cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.707 4.293a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L10 8.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        從描述總結標題
                    </button>
                </div>
                <div class="border-t border-slate-200"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="add-task-category" class="block text-sm font-medium text-slate-600 mb-1.5">任務分類</label>
                        <select id="add-task-category" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                    </div>
                     <div>
                        <label for="add-task-due-date" class="block text-sm font-medium text-slate-600 mb-1.5">截止日期 (可選)</label>
                        <input type="date" id="add-task-due-date" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                    </div>
                </div>
                <div>
                    <label for="add-task-title" class="block text-sm font-medium text-slate-600 mb-1.5">任務標題</label>
                    <div class="relative">
                        <input type="text" id="add-task-title" placeholder="請輸入任務標題..." class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition pr-20" required>
                         <div class="absolute top-0 right-0 h-full flex items-center space-x-1 pr-2">
                            <button type="button" id="paste-btn-title" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="貼上"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>
                            <button type="button" id="voice-input-btn-title" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="語音輸入"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 2a1 1 0 11-2 0V4a1 1 0 112 0v2zm-4 4a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" /><path d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg></button>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="add-task-desc" class="block text-sm font-medium text-slate-600 mb-1.5">任務描述 (可選)</label>
                    <div class="relative">
                        <textarea id="add-task-desc" rows="3" placeholder="請輸入任務描述..." class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition pr-28"></textarea>
                        <div class="absolute top-2 right-0 h-full flex flex-col space-y-1 pr-2">
                           <button type="button" id="paste-btn-desc" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="貼上"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>
                           <button type="button" id="voice-input-btn-desc" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="語音輸入"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 2a1 1 0 11-2 0V4a1 1 0 112 0v2zm-4 4a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" /><path d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg></button>
                           <button type="button" id="image-input-btn" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="圖片輸入"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    <input type="file" id="image-input-file" class="hidden" accept="image/*">
                    <div id="image-preview-container" class="mt-2"></div>
                </div>
                 <p id="voice-status" class="text-sm text-center text-slate-500 h-5"></p>
                <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300/80">新增任務</button>
            </form>
        </div>

        <div class="mb-6">
            <div class="hidden sm:block">
                <div class="border-b border-slate-200">
                    <nav id="category-tabs" class="-mb-px flex space-x-2" aria-label="Tabs"></nav>
                </div>
            </div>
             <div class="sm:hidden">
                <label for="tabs-select" class="sr-only">選擇分類</label>
                <select id="tabs-select" class="block w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500"></select>
            </div>
        </div>

        <div class="mb-6">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <input type="search" id="search-input" placeholder="在目前分類中搜尋標題或描述..." class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-2">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center px-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h4a1 1 0 100-2H7zm0 4a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>待辦事項</h2>
                <div id="todo-list" class="space-y-4"></div>
            </div>
            <div class="space-y-2">
                 <div class="flex justify-between items-center px-2">
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>已處理</h2>
                    <button id="clear-completed-btn" class="text-sm text-rose-600 hover:text-rose-800 font-semibold transition-colors flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>清除</button>
                </div>
                <div id="completed-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp, enableIndexedDbPersistence, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { apiKey: "AIzaSyDDAYiLAtQKkusNSR6Yw54d39F7ruWfhv8", authDomain: "team-task-app-73ec0.firebaseapp.com", projectId: "team-task-app-73ec0", storageBucket: "team-task-app-73ec0.appspot.com", messagingSenderId: "544030228623", appId: "1:544030228623:web:245b75df7fc0d4301030fa" };
            const CATEGORIES = ["董總交辦", "行政管理", "運籌管理", "有機植萃", "品質管理"];
            const STATUSES = { TODO: "待辦事項", HOLD: "暫緩中", COMPLETED: "已完成" };
            const CREATOR_COLORS = { "董事長": "border-rose-500", "總經理": "border-sky-500", "使用者": "border-slate-400", "未知": "border-slate-300" };
            const savedCategory = localStorage.getItem('activeCategory');
            let activeCategory = (savedCategory && CATEGORIES.includes(savedCategory)) ? savedCategory : CATEGORIES[0];
            const userName = '使用者';
            let localTasksCache = [];
            let unsubscribe;
            let currentEditingTaskId = null;
            let currentImageBase64 = null;
            let activeRecognitionTarget = null;
            let db;

            const dom = {
                loadingOverlay: document.getElementById('loading-overlay'),
                offlineStatus: document.getElementById('offline-status'),
                addTaskForm: document.getElementById('add-task-form'),
                addTaskCategory: document.getElementById('add-task-category'),
                addTaskTitle: document.getElementById('add-task-title'),
                addTaskDesc: document.getElementById('add-task-desc'),
                addTaskDueDate: document.getElementById('add-task-due-date'),
                todoList: document.getElementById('todo-list'),
                completedList: document.getElementById('completed-list'),
                clearCompletedBtn: document.getElementById('clear-completed-btn'),
                categoryTabsContainer: document.getElementById('category-tabs'),
                tabsSelect: document.getElementById('tabs-select'),
                editModalOverlay: document.getElementById('edit-modal-overlay'),
                editTaskForm: document.getElementById('edit-task-form'),
                editTaskCategory: document.getElementById('edit-task-category'),
                editTaskDueDate: document.getElementById('edit-task-due-date'),
                editTaskTitle: document.getElementById('edit-task-title'),
                editTaskDesc: document.getElementById('edit-task-desc'),
                cancelEditBtn: document.getElementById('cancel-edit-btn'),
                aiInspirationBtn: document.getElementById('ai-inspiration-btn'),
                aiSummarizeBtn: document.getElementById('ai-summarize-btn'),
                voiceInputBtnTitle: document.getElementById('voice-input-btn-title'),
                voiceInputBtnDesc: document.getElementById('voice-input-btn-desc'),
                imageInputBtn: document.getElementById('image-input-btn'),
                imageFileInput: document.getElementById('image-input-file'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                voiceStatus: document.getElementById('voice-status'),
                pasteBtnTitle: document.getElementById('paste-btn-title'),
                pasteBtnDesc: document.getElementById('paste-btn-desc'),
                searchInput: document.getElementById('search-input'),
            };

            function startApp() {
                if (!firebaseConfig.apiKey.startsWith("AIza")) { showError("您尚未設定 Firebase！"); return; }
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                enableIndexedDbPersistence(db).catch(err => console.warn("Firebase Persistence Error:", err.message));
                onAuthStateChanged(auth, user => {
                    if (user) { bootstrapMainApp(); } 
                    else { signInAnonymously(auth).catch(error => { console.error("匿名登入失敗:", error); showError(`Firebase 認證失敗: ${error.message}`); }); }
                });
            }

            function bootstrapMainApp() {
                dom.loadingOverlay.style.display = 'none';
                initializeUI();
                bindEventListeners();
                listenForTasks();
                initializeDragAndDrop();
            }

            function initializeDragAndDrop() {
                new Sortable(dom.todoList, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const taskElements = dom.todoList.querySelectorAll('.task-card');
                        const batch = writeBatch(db);
                        taskElements.forEach((el, index) => {
                            const taskId = el.dataset.id;
                            if(taskId) {
                                const taskRef = doc(db, 'tasks', taskId);
                                batch.update(taskRef, { order: index });
                            }
                        });
                        try { await batch.commit(); } 
                        catch (error) { console.error("更新任務順序失敗:", error); }
                    },
                });
            }

            function listenForTasks() {
                const tasksCollection = collection(db, 'tasks');
                if (unsubscribe) unsubscribe();
                unsubscribe = onSnapshot(tasksCollection, (snapshot) => {
                    if (dom.offlineStatus) {
                        dom.offlineStatus.classList.toggle('hidden', !snapshot.metadata.fromCache);
                    }
                    localTasksCache = snapshot.docs.map(doc => ({ order: Infinity, status: STATUSES.TODO, createdBy: '未知', category: CATEGORIES[0], subtasks: [], ...doc.data(), id: doc.id }));
                    renderTasks();
                }, (error) => { console.error("監聽任務時發生錯誤:", error); showError("無法讀取雲端資料。"); });
            }

            function renderTasks() {
                ['todoList', 'completedList'].forEach(key => dom[key].innerHTML = '');
                const searchTerm = dom.searchInput.value.toLowerCase();
                const categoryTasks = localTasksCache.filter(task => task.category === activeCategory);
                const filteredTasks = searchTerm ? categoryTasks.filter(task => (task.title || "").toLowerCase().includes(searchTerm) || (task.description || "").toLowerCase().includes(searchTerm)) : categoryTasks;
                
                const todoTasks = filteredTasks.filter(t => t.status === STATUSES.TODO || t.status === STATUSES.HOLD).sort((a,b) => a.order - b.order);
                const processedTasks = filteredTasks.filter(t => t.status === STATUSES.COMPLETED).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                if (categoryTasks.length === 0) {
                     const emptyStateHTML = `<div class="text-center p-8 bg-white rounded-xl border border-dashed border-slate-300 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg><h3 class="mt-4 text-lg font-semibold text-slate-700">這個分類沒有任務</h3><p class="mt-1 text-sm">試著新增一項任務，或切換到其他分類吧！</p></div>`;
                     dom.todoList.innerHTML = emptyStateHTML;
                } else {
                     if (todoTasks.length > 0) todoTasks.forEach(task => dom.todoList.appendChild(createTaskElement(task)));
                     else dom.todoList.innerHTML = `<div class="text-center p-8 bg-white rounded-xl border border-dashed border-slate-300 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-4 text-lg font-semibold text-slate-700">太棒了！</h3><p class="mt-1 text-sm">${searchTerm ? '找不到符合的待辦任務。' : '所有待辦事項都已處理完畢。'}</p></div>`;

                     if (processedTasks.length > 0) processedTasks.forEach(task => dom.completedList.appendChild(createTaskElement(task)));
                     else dom.completedList.innerHTML = `<p class="text-center text-sm text-slate-500 p-4">暫無已處理的項目</p>`
                }
            }
            
            function highlightText(text, searchTerm) {
                if (!searchTerm || !text) return text;
                const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                return text.replace(regex, `<mark>$1</mark>`);
            }

            function createTaskElement(task) {
                const card = document.createElement('div');
                card.dataset.id = task.id;
                const creatorColor = CREATOR_COLORS[task.createdBy] || CREATOR_COLORS['未知'];
                const titleText = (task.title && task.title.trim()) ? task.title : '無標題任務';
                card.className = `task-card bg-white p-4 rounded-lg shadow-sm border-l-4 ${creatorColor} flex flex-col`;
                if (task.status === STATUSES.COMPLETED) card.classList.add('opacity-70');
                
                let statusBadge = '';
                if (task.status === STATUSES.HOLD) statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 bg-amber-100 text-amber-800 rounded-full">暫緩中</span>`; 
                else if (task.status === STATUSES.COMPLETED) statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 bg-emerald-100 text-emerald-800 rounded-full">已完成</span>`; 

                const dueDateHTML = task.dueDate ? `<p class="text-xs text-slate-500 mt-1">截止於 ${new Date(task.dueDate).toLocaleDateString('zh-TW')}</p>` : '';
                const imageHTML = task.imageData ? `<img src="${task.imageData}" class="mt-3 rounded-lg max-h-48 w-auto shadow-sm">` : '';

                const searchTerm = dom.searchInput.value;
                const titleHTML = highlightText(titleText, searchTerm);
                const descHTML = highlightText(task.description || '', searchTerm);

                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-slate-800 pr-2">${titleHTML}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-slate-600 text-sm whitespace-pre-wrap">${descHTML}</p>
                        ${imageHTML}
                    </div>
                     <div id="subtasks-container-${task.id}" class="mt-4"></div>
                    <div class="mt-3 pt-3 border-t border-slate-200/80 flex justify-between items-center text-xs">
                         <div>
                            <p class="font-medium text-slate-500">${task.createdBy} 交辦</p>
                            ${dueDateHTML}
                        </div>
                        <div class="relative flex items-center space-x-1">
                            ${generateActionButtons(task)}
                        </div>
                    </div>
                `;
                
                renderSubtasks(task, card.querySelector(`#subtasks-container-${task.id}`));
                card.querySelector('.delete-btn')?.addEventListener('click', () => deleteTask(task.id));
                card.querySelector('.edit-btn')?.addEventListener('click', () => showEditModal(task));
                card.querySelector('.action-menu-btn')?.addEventListener('click', (e) => { e.stopPropagation(); card.querySelector('.action-menu').classList.toggle('hidden'); });
                card.querySelectorAll('.action-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        updateTaskStatus(task.id, e.target.dataset.status);
                    });
                });
                 card.querySelector('.generate-subtasks-btn')?.addEventListener('click', (e) => handleGenerateSubtasks(e, task));

                return card;
            }

            function generateActionButtons(task) {
                const editButtonHTML = `<button class="edit-btn p-1.5 text-slate-400 hover:bg-indigo-100 hover:text-indigo-600 rounded-full transition-colors" title="編輯任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>`;
                const deleteButtonHTML = `<button class="delete-btn p-1.5 text-slate-400 hover:bg-rose-100 hover:text-rose-600 rounded-full transition-colors" title="刪除任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
                let mainAction = '';

                switch(task.status) {
                    case STATUSES.TODO:
                        mainAction = `<div class="relative"><button class="action-menu-btn p-1.5 text-slate-400 hover:bg-emerald-100 hover:text-emerald-600 rounded-full transition-colors" title="操作"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button><div class="action-menu hidden origin-top-right absolute right-0 bottom-full mb-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"><div class="py-1"><a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.COMPLETED}">完成</a><a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.HOLD}">暫緩</a></div></div></div>`;
                        break;
                    case STATUSES.HOLD:
                        mainAction = `<div class="relative"><button class="action-menu-btn p-1.5 text-slate-400 hover:bg-amber-100 hover:text-amber-600 rounded-full transition-colors" title="操作"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg></button><div class="action-menu hidden origin-top-right absolute right-0 bottom-full mb-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"><div class="py-1"><a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.TODO}">恢復處理</a><a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.COMPLETED}">完成</a></div></div></div>`;
                        break;
                    case STATUSES.COMPLETED:
                        mainAction = `<button class="action-option p-1.5 text-slate-400 hover:bg-amber-100 hover:text-amber-600 rounded-full transition-colors" title="復原任務" data-status="${STATUSES.TODO}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.707 14.707a1 1 0 01-1.414 0L4.586 12a1 1 0 111.414-1.414L8 12.586l5.293-5.293a1 1 0 111.414 1.414l-6 6z" /></svg></button>`;
                        break;
                }
                return mainAction + editButtonHTML + deleteButtonHTML;
            }
            
            function initializeUI() {
                [dom.addTaskCategory, dom.editTaskCategory].forEach(select => {
                    select.innerHTML = '';
                    CATEGORIES.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat; option.textContent = cat;
                        select.appendChild(option);
                    });
                });
                dom.categoryTabsContainer.innerHTML = '';
                CATEGORIES.forEach(cat => {
                    const tabButton = document.createElement('a');
                    tabButton.href = '#';
                    tabButton.dataset.category = cat;
                    tabButton.className = `px-4 py-2 text-sm font-semibold rounded-md transition-colors duration-200 ${cat === activeCategory ? 'tab-active' : 'tab-inactive'}`;
                    tabButton.textContent = cat;
                    tabButton.addEventListener('click', (e) => { e.preventDefault(); updateActiveTab(cat); });
                    dom.categoryTabsContainer.appendChild(tabButton);
                });
                updateActiveTab(activeCategory);
            }

            function bindEventListeners() {
                dom.addTaskForm.addEventListener('submit', handleAddTask);
                dom.tabsSelect.addEventListener('change', (e) => updateActiveTab(e.target.value));
                dom.editTaskForm.addEventListener('submit', handleUpdateTask);
                dom.cancelEditBtn.addEventListener('click', hideEditModal);
                dom.searchInput.addEventListener('input', renderTasks);
                document.body.addEventListener('click', (e) => {
                    if (!e.target.closest('.action-menu-btn')) {
                        document.querySelectorAll('.action-menu').forEach(menu => menu.classList.add('hidden'));
                    }
                });
            }
            
            async function handleAddTask(e) { e.preventDefault(); const newOrder = dom.todoList.querySelectorAll('.task-card').length; const newTask = { title: dom.addTaskTitle.value, description: dom.addTaskDesc.value, dueDate: dom.addTaskDueDate.value, createdAt: serverTimestamp(), category: dom.addTaskCategory.value, createdBy: userName, status: STATUSES.TODO, order: newOrder }; try { await addDoc(collection(db, 'tasks'), newTask); dom.addTaskForm.reset(); dom.addTaskCategory.value = activeCategory; } catch (error) { console.error("新增任務失敗:", error); } }
            async function updateTaskStatus(id, newStatus) { await updateDoc(doc(db, 'tasks', id), { status: newStatus }); }
            async function deleteTask(id) { if (!id) return; await deleteDoc(doc(db, 'tasks', id)); }
            
            function showEditModal(task) { currentEditingTaskId = task.id; dom.editTaskTitle.value = task.title || ''; dom.editTaskDesc.value = task.description || ''; dom.editTaskDueDate.value = task.dueDate || ''; dom.editTaskCategory.value = task.category || CATEGORIES[0]; dom.editModalOverlay.classList.remove('hidden'); dom.editModalOverlay.classList.add('flex'); }
            function hideEditModal() { currentEditingTaskId = null; dom.editModalOverlay.classList.add('hidden'); dom.editModalOverlay.classList.remove('flex'); }
            
            async function handleUpdateTask(e) { e.preventDefault(); if (!currentEditingTaskId) return; const updatedData = { title: dom.editTaskTitle.value, description: dom.editTaskDesc.value, dueDate: dom.editTaskDueDate.value, category: dom.editTaskCategory.value }; try { await updateDoc(doc(db, 'tasks', currentEditingTaskId), updatedData); hideEditModal(); } catch (error) { console.error("更新任務失敗:", error); } }
            function updateActiveTab(newCategory) { activeCategory = newCategory; localStorage.setItem('activeCategory', activeCategory); dom.categoryTabsContainer.querySelectorAll('a').forEach(tab => { tab.classList.toggle('tab-active', tab.dataset.category === activeCategory); tab.classList.toggle('tab-inactive', tab.dataset.category !== activeCategory); }); dom.tabsSelect.value = activeCategory; renderTasks(); }
            function showError(message) { dom.loadingOverlay.innerHTML = `<div class="text-center text-red-700 bg-red-100 p-4 rounded-lg"><h3>錯誤</h3><p>${message}</p></div>`; dom.loadingOverlay.style.display = 'flex'; }
            
            function renderSubtasks(task, container) {
                if (!container) return; container.innerHTML = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    container.innerHTML = '<h4 class="text-sm font-semibold mb-2 text-slate-600">子任務：</h4>';
                    const ul = document.createElement('ul'); ul.className = 'space-y-2 pl-1 mb-3';
                    task.subtasks.forEach((subtask, index) => {
                        const li = document.createElement('li'); li.className = 'flex items-center justify-between group';
                        li.innerHTML = `<div class="flex items-center flex-grow"><input type="checkbox" id="subtask-${task.id}-${index}" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${subtask.completed ? 'checked' : ''}><label for="subtask-${task.id}-${index}" class="ml-3 block text-sm text-slate-700 ${subtask.completed ? 'line-through text-slate-400' : ''}">${subtask.text}</label></div><button class="delete-subtask-btn text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition px-2" title="刪除子任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>`;
                        li.querySelector('input[type="checkbox"]').addEventListener('change', () => toggleSubtaskCompletion(task.id, index));
                        li.querySelector('.delete-subtask-btn').addEventListener('click', () => deleteSubtask(task.id, index));
                        ul.appendChild(li);
                    }); container.appendChild(ul);
                }
                if (task.status !== STATUSES.COMPLETED) {
                    const addSubtaskForm = document.createElement('form'); addSubtaskForm.className = 'mt-2 flex items-center space-x-2';
                    addSubtaskForm.innerHTML = `<input type="text" placeholder="新增子任務..." class="flex-grow w-full text-sm px-3 py-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition"><button type="submit" class="text-sm bg-slate-200 text-slate-600 font-semibold py-1.5 px-3 rounded-md hover:bg-slate-300 transition flex-shrink-0">新增</button><button type="button" class="generate-subtasks-btn p-1.5 text-slate-400 hover:bg-indigo-100 hover:text-indigo-600 rounded-full transition-colors" title="AI 產生子任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></button>`;
                    const input = addSubtaskForm.querySelector('input');
                    addSubtaskForm.addEventListener('submit', (e) => { e.preventDefault(); if (input.value.trim()) { addSubtask(task.id, input.value.trim()); input.value = ''; } });
                    container.appendChild(addSubtaskForm);
                }
            }
            async function addSubtask(taskId, subtaskText) { const task = localTasksCache.find(t => t.id === taskId); const newSubtask = { text: subtaskText, completed: false }; const updatedSubtasks = [...(task.subtasks || []), newSubtask]; await updateDoc(doc(db, 'tasks', taskId), { subtasks: updatedSubtasks }); }
            async function deleteSubtask(taskId, subtaskIndex) { const task = localTasksCache.find(t => t.id === taskId); const updatedSubtasks = [...task.subtasks]; updatedSubtasks.splice(subtaskIndex, 1); await updateDoc(doc(db, 'tasks', taskId), { subtasks: updatedSubtasks }); }
            async function toggleSubtaskCompletion(taskId, subtaskIndex) { const task = localTasksCache.find(t => t.id === taskId); const updatedSubtasks = [...task.subtasks]; updatedSubtasks[subtaskIndex].completed = !updatedSubtasks[subtaskIndex].completed; await updateDoc(doc(db, 'tasks', taskId), { subtasks: updatedSubtasks }); }
            function updateAiSummarizeBtnState() { const enabled = dom.addTaskDesc.value.trim() !== ''; dom.aiSummarizeBtn.disabled = !enabled; dom.aiSummarizeBtn.classList.toggle('cursor-not-allowed', !enabled); dom.aiSummarizeBtn.classList.toggle('ai-btn-enabled', enabled); }
            function handleImageUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { currentImageBase64 = e.target.result; displayImagePreview(currentImageBase64); generateDescriptionFromImage(currentImageBase64); }; reader.readAsDataURL(file); }
            function displayImagePreview(base64) { dom.imagePreviewContainer.innerHTML = `<div class="relative inline-block group"><img src="${base64}" class="h-24 w-auto rounded-lg shadow-md"><button type="button" class="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition">&times;</button></div>`; dom.imagePreviewContainer.querySelector('button').addEventListener('click', () => { currentImageBase64 = null; dom.imagePreviewContainer.innerHTML = ''; dom.imageFileInput.value = ''; }); }
            async function handlePaste(targetInput) { try { const text = await navigator.clipboard.readText(); targetInput.value = text; if (targetInput === dom.addTaskDesc) updateAiSummarizeBtnState(); } catch (error) { console.error('貼上失敗:', error); } }
            async function callGemini(payload) { const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`); return await response.json(); } catch (error) { console.error('Gemini API 呼叫失敗:', error); dom.voiceStatus.textContent = 'AI 功能暫時無法使用。'; setTimeout(() => dom.voiceStatus.textContent = '', 3000); return null; } }
            async function handleAiInspiration(e) { const btn = e.currentTarget; const originalContent = btn.innerHTML; btn.disabled = true; btn.innerHTML = '尋找靈感中...'; const payload = { contents: [{ parts: [{ text: `請提供一個常見的工作任務範本，包含'title'和'description'。description 可以用換行符號 \\n 分點。請只回傳 JSON 格式，例如：{\"title\": \"準備週會報告\", \"description\": \"1. 整理上週數據\\n2. 製作簡報\\n3. 預演練習\"}` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "title": { "type": "STRING" }, "description": { "type": "STRING" } }, required: ["title", "description"] } } }; const result = await callGemini(payload); if (result) { const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text; if (responseText) { const parsed = JSON.parse(responseText); dom.addTaskTitle.value = parsed.title || ''; dom.addTaskDesc.value = parsed.description || ''; updateAiSummarizeBtnState(); } } btn.disabled = false; btn.innerHTML = originalContent; }
            async function handleAiSummarize(e) { if (!dom.addTaskDesc.value.trim()) return; const btn = e.currentTarget; const originalContent = btn.innerHTML; btn.disabled = true; btn.innerHTML = '總結中...'; const payload = { contents: [{ parts: [{ text: `請根據以下任務描述，總結出一個簡潔、明確的任務標題。請只回傳標題文字，不要包含任何引號或額外說明。\n\n描述：\n"${dom.addTaskDesc.value.trim()}"` }] }] }; const result = await callGemini(payload); if (result) { let summary = result.candidates?.[0]?.content?.parts?.[0]?.text || ''; dom.addTaskTitle.value = summary.trim().replace(/^"|"$/g, '').replace(/\*+/g, ''); } btn.disabled = false; btn.innerHTML = originalContent; }
            async function generateDescriptionFromImage(base64Data) { dom.addTaskDesc.value = '📸 正在分析圖片...'; updateAiSummarizeBtnState(); const payload = { contents: [{ parts: [{ text: "請根據這張圖片產生一段簡短、客觀的任務描述。例如：『修理水龍頭漏水』或『整理桌面上的文件』。" }, { inlineData: { mimeType: "image/jpeg", data: base64Data.split(',')[1] } }] }] }; const result = await callGemini(payload); if(result) { const description = result.candidates?.[0]?.content?.parts?.[0]?.text; dom.addTaskDesc.value = description || '無法從圖片產生描述。'; } else { dom.addTaskDesc.value = '圖片描述產生失敗。'; } updateAiSummarizeBtnState(); }
            async function handleGenerateSubtasks(e, task) { const btn = e.currentTarget; btn.disabled = true; const payload = { contents: [{ parts: [{ text: `將這個任務分解成子任務清單。任務標題: "${task.title}"；任務描述: "${task.description || '無'}"。請只回傳一個 JSON 陣列，內容是子任務的字串。例如: ["買機票", "訂飯店"]` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "STRING" } } } }; const result = await callGemini(payload); if (result) { const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text; if (responseText) { const jsonString = responseText.substring(responseText.indexOf('['), responseText.lastIndexOf(']') + 1); const subtaskTexts = JSON.parse(jsonString); const newSubtasks = subtaskTexts.map(text => ({ text, completed: false })); await updateDoc(doc(db, 'tasks', task.id), { subtasks: [...(task.subtasks || []), ...newSubtasks] }); } } btn.disabled = false; }
            
            startApp();
        });
    </script>
</body>
</html>

