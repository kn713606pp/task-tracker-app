<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>麻將戰績分析中心</title>
    
    <!-- For "Add to Home Screen" on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="麻將戰績">
    <!-- You can add an icon for the home screen here -->
    <!-- <link rel="apple-touch-icon" href="path/to/icon.png"> -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* indigo-600 */
            --primary-hover: #4338ca; /* indigo-700 */
            --background: #f3f4f6; /* gray-100 */
            --positive-color: #16a34a; /* green-600 */
            --negative-color: #dc2626; /* red-600 */
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--background);
            -webkit-tap-highlight-color: transparent;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; transform: translateY(20px); opacity: 0; }
        .modal-open .modal-content { transform: translateY(0); opacity: 1; }
        .score-positive { color: var(--positive-color); }
        .score-negative { color: var(--negative-color); }
        .btn-primary { background-color: var(--primary-color); color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .view-switch-btn.active { background-color: var(--primary-color); color: white; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .day-cell { min-height: 90px; cursor: pointer; }
        .day-cell:hover { background-color: #eef2ff; }
        .day-cell.has-record { background-color: #e0e7ff; font-weight: bold; }
        .day-cell.has-record:hover { background-color: #c7d2fe; }
        .day-cell.other-month { cursor: default; background-color: #f9fafb; }
        .day-cell.other-month .day-number { color: #d1d5db; }
        .day-cell.today .day-number { color: var(--primary-color); font-weight: 700; border: 2px solid var(--primary-color); border-radius: 9999px; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; padding: 2px; }
        .speech-btn.recording { color: #ef4444; }
        .stat-card { background: linear-gradient(145deg, #f9fafb, #eef2ff); }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="container mx-auto p-4 sm:p-6 max-w-7xl">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">麻將牌局紀錄</h1>
                <p class="text-gray-600 mt-1">詳細記錄與分析每一場激戰</p>
            </div>
             <div class="flex items-center gap-4">
                <button id="dashboard-btn" class="flex items-center gap-2 bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-50 transition">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6m4-6v6a2 2 0 002 2h2a2 2 0 002-2v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2z"></path></svg>
                    <span>查看儀表板</span>
                </button>
                <div class="bg-gray-200 p-1 rounded-lg flex">
                    <button id="view-list-btn" class="view-switch-btn px-4 py-2 text-sm font-semibold rounded-md transition">列表模式</button>
                    <button id="view-calendar-btn" class="view-switch-btn px-4 py-2 text-sm font-semibold rounded-md transition">行事曆</button>
                </div>
                <button id="add-session-btn" class="flex items-center justify-center gap-2 btn-primary font-bold py-3 px-5 rounded-lg shadow-lg hover:scale-105 transform transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>新增牌局</span>
                </button>
            </div>
        </header>

        <main>
            <div id="list-view" class="space-y-6"></div>
            <div id="calendar-view" class="hidden">
                 <div class="flex justify-between items-center mb-4 p-2 bg-white rounded-lg shadow">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                    <h2 id="month-year-display" class="text-xl font-bold text-gray-900"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                </div>
                 <div class="bg-white rounded-xl shadow-lg">
                    <div class="calendar-grid border-b"><div class="text-center font-semibold text-red-500 py-2">日</div><div class="text-center font-semibold text-gray-600 py-2">一</div><div class="text-center font-semibold text-gray-600 py-2">二</div><div class="text-center font-semibold text-gray-600 py-2">三</div><div class="text-center font-semibold text-gray-600 py-2">四</div><div class="text-center font-semibold text-gray-600 py-2">五</div><div class="text-center font-semibold text-green-500 py-2">六</div></div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) {
        recognition.continuous = false;
        recognition.lang = 'cmn-Hant-TW';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    }

    const app = {
        state: {
            mainPlayerName: "我",
            records: [], // { id, date, ...}
            view: 'list', // Default view is now list
            calendarDate: new Date(),
            dashboardSelectedPlayers: [],
        },
        chartInstance: null,
        elements: {
            addSessionBtn: document.getElementById('add-session-btn'),
            listView: document.getElementById('list-view'),
            calendarView: document.getElementById('calendar-view'),
            viewListBtn: document.getElementById('view-list-btn'),
            viewCalendarBtn: document.getElementById('view-calendar-btn'),
            dashboardBtn: document.getElementById('dashboard-btn'),
            modalContainer: document.getElementById('modal-container'),
            monthYearDisplay: document.getElementById('month-year-display'),
            calendarGrid: document.getElementById('calendar-grid'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
        },
        init() {
            this.loadState();
            this.render();
            this.bindEvents();
            this.renderCalendar();
        },
        bindEvents() {
            this.elements.addSessionBtn.onclick = () => this.openModal();
            this.elements.dashboardBtn.onclick = () => this.openDashboardModal();
            
            const listAndModalClickHandler = e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const exportBtn = e.target.closest('.export-btn');
                if (editBtn) this.openModal(editBtn.dataset.id);
                if (deleteBtn) this.deleteRecord(deleteBtn.dataset.id);
                if (exportBtn) this.exportToICS(exportBtn.dataset.id);
            };
            this.elements.listView.addEventListener('click', listAndModalClickHandler);
            this.elements.modalContainer.addEventListener('click', listAndModalClickHandler);
            
            this.elements.viewListBtn.onclick = () => this.setView('list');
            this.elements.viewCalendarBtn.onclick = () => this.setView('calendar');
            this.elements.prevMonthBtn.onclick = () => this.changeMonth(-1);
            this.elements.nextMonthBtn.onclick = () => this.changeMonth(1);
            this.elements.calendarGrid.addEventListener('click', e => {
                const cell = e.target.closest('.day-cell:not(.other-month)');
                if (cell) {
                    this.openDailyModal(cell.dataset.date);
                }
            });
        },
        loadState() {
            const mainPlayerName = localStorage.getItem('mahjong_main_player_v12');
            if (mainPlayerName) this.state.mainPlayerName = mainPlayerName;

            const records = localStorage.getItem('mahjong_sessions_v12');
            if (records && JSON.parse(records).length > 0) {
                 this.state.records = JSON.parse(records);
            } else {
                this.state.records = [
                    {id: "1726336800001", date: "2025-09-14", startTime: "20:00", endTime: "23:30", location: "桃園龍潭住家", base: "100", points: "20", mode: "chips", players: [{name: "我", score: 1250}, {name: "雅玲", score: -600}, {name: "志強", score: -450}, {name: "小明", score: -200}], myScore: null},
                    {id: "1726164000001", date: "2025-09-12", startTime: "19:00", endTime: "22:00", location: "中壢小明家", base: "50", points: "10", mode: "chips", players: [{name: "我", score: -1800}, {name: "小明", score: 2500}, {name: "志強", score: -300}, {name: "阿傑", score: -400}], myScore: null},
                    {id: "1726171200002", date: "2025-09-12", startTime: "22:30", endTime: "23:59", location: "中壢小明家", base: "50", points: "10", mode: "cash", players: [], myScore: 650},
                    {id: "1725732000001", date: "2025-09-07", startTime: "14:00", endTime: "18:00", location: "新竹麻將館", base: "200", points: "50", mode: "chips", players: [{name: "我", score: 2400}, {name: "志強", score: -1000}, {name: "陌生人A", score: -800}, {name: "陌生人B", score: -600}], myScore: null},
                    {id: "1725040800001", date: "2025-08-30", startTime: "21:00", endTime: "23:50", location: "桃園龍潭住家", base: "100", points: "20", mode: "chips", players: [{name: "我", score: -350}, {name: "雅玲", score: 1100}, {name: "阿姨", score: -500}, {name: "舅舅", score: -250}], myScore: null},
                    {id: "1724599200001", date: "2025-08-25", startTime: "15:00", endTime: "17:00", location: "中壢小明家", base: "50", points: "10", mode: "cash", players: [], myScore: -500},
                ];
            }
            this.state.records.sort((a, b) => new Date(`${b.date}T${b.startTime}`) - new Date(`${a.date}T${a.startTime}`));
        },
        saveState() {
            localStorage.setItem('mahjong_main_player_v12', this.state.mainPlayerName);
            this.state.records.sort((a, b) => new Date(`${b.date}T${b.startTime}`) - new Date(`${a.date}T${a.startTime}`));
            localStorage.setItem('mahjong_sessions_v12', JSON.stringify(this.state.records));
        },
        render() {
            this.elements.viewListBtn.classList.toggle('active', this.state.view === 'list');
            this.elements.viewCalendarBtn.classList.toggle('active', this.state.view === 'calendar');
            this.elements.listView.classList.toggle('hidden', this.state.view !== 'list');
            this.elements.calendarView.classList.toggle('hidden', this.state.view !== 'calendar');

            if (this.state.view === 'list') this.renderListView();
            else this.renderCalendarView();
        },
        // --- Dashboard Modal ---
        openDashboardModal() {
            const allPlayerNames = this.getAllPlayerNames();
            this.state.dashboardSelectedPlayers = [...allPlayerNames]; // Select all by default

            const playerCheckboxes = [...allPlayerNames].map(name => `
                <label class="flex items-center gap-2 text-sm p-2 rounded-md hover:bg-gray-100">
                    <input type="checkbox" name="dashboard-player" value="${name}" class="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500" checked>
                    ${name}
                </label>
            `).join('');

            const modalHTML = `
            <div id="dashboard-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
                <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl modal-content max-h-[90vh] flex flex-col">
                    <div class="p-5 border-b flex justify-between items-center">
                        <h3 class="text-xl font-semibold">戰績儀表板</h3>
                        <button id="close-dashboard-modal-btn" class="p-2 text-gray-400 hover:text-gray-700 rounded-full text-2xl leading-none">&times;</button>
                    </div>
                    <div class="p-6 flex-grow overflow-y-auto">
                        <section id="dashboard-panel">
                            <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">個人數據分析</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <label for="main-player-select-dashboard" class="text-sm text-gray-600 whitespace-nowrap">分析對象：</label>
                                        <select id="main-player-select-dashboard" class="p-2 border rounded-md text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none w-32"></select>
                                    </div>
                                </div>
                                <div class="text-left md:text-right">
                                    <h3 class="font-bold text-lg text-indigo-700">${this.state.calendarDate.getFullYear()}年 ${this.state.calendarDate.getMonth() + 1}月統計</h3>
                                    <button id="export-month-btn" class="mt-1 text-xs bg-green-100 text-green-700 font-semibold py-1 px-3 rounded-full hover:bg-green-200 transition flex items-center gap-1 ml-auto md:ml-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        <span>匯出本月紀錄</span>
                                    </button>
                                </div>
                            </div>
                            <div id="personal-stats-content" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8"></div>
                            
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 mb-2">玩家戰績比較圖</h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="md:col-span-1 p-4 border rounded-lg bg-gray-50 max-h-60 overflow-y-auto">
                                        <p class="font-semibold text-sm mb-2">選擇比較玩家：</p>
                                        <div id="dashboard-player-checkboxes" class="flex flex-col gap-1">${playerCheckboxes}</div>
                                    </div>
                                    <div class="md:col-span-3 min-h-[250px]"><canvas id="monthly-chart"></canvas></div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>`;
            this.elements.modalContainer.innerHTML = modalHTML;
            requestAnimationFrame(() => document.getElementById('dashboard-modal').classList.add('modal-open'));

            document.getElementById('close-dashboard-modal-btn').onclick = () => this.closeModal('dashboard-modal');
            
            this.renderDashboardContent(); // Initial render
            
            // Bind events for dashboard content
            document.getElementById('main-player-select-dashboard').onchange = e => {
                this.state.mainPlayerName = e.target.value;
                this.saveState();
                this.renderPersonalStats(document.getElementById('personal-stats-content')); // Re-render only stats
            };
            document.getElementById('dashboard-player-checkboxes').onchange = e => {
                 this.state.dashboardSelectedPlayers = [...document.querySelectorAll('input[name="dashboard-player"]:checked')].map(el => el.value);
                 this.renderMonthlyChart(document.getElementById('monthly-chart')); // Re-render only chart
            };
            document.getElementById('export-month-btn').onclick = () => this.exportMonthToICS();
        },
        renderDashboardContent() {
            this.renderPlayerSelector(document.getElementById('main-player-select-dashboard'));
            this.renderPersonalStats(document.getElementById('personal-stats-content'));
            this.renderMonthlyChart(document.getElementById('monthly-chart'));
        },
        getAllPlayerNames() {
            const allPlayerNames = new Set(["我"]);
            this.state.records.forEach(rec => {
                if (rec.mode === 'chips') {
                    rec.players.forEach(p => allPlayerNames.add(p.name));
                }
            });
            return [...allPlayerNames].sort();
        },
        renderPlayerSelector(selectElement) {
            const allPlayerNames = this.getAllPlayerNames();
            if (!allPlayerNames.includes(this.state.mainPlayerName)) {
                this.state.mainPlayerName = "我";
            }
            selectElement.innerHTML = allPlayerNames.map(name =>
                `<option value="${name}" ${this.state.mainPlayerName === name ? 'selected' : ''}>${name}</option>`
            ).join('');
        },
        renderPersonalStats(containerElement) { /* ... same logic as before, but takes a container ... */ },
        renderMonthlyChart(canvasElement) { /* ... same logic as before, but takes a canvas ... */ },
        setView(view) { this.state.view = view; this.render(); },
        renderListView() { /* ... unchanged ... */ },
        renderCard(rec) { /* ... modified to add export button ... */ },
        renderCalendarView() { this.renderCalendar(); },
        renderCalendar() { /* ... unchanged ... */ },
        changeMonth(delta) { this.state.calendarDate.setMonth(this.state.calendarDate.getMonth() + delta); this.render(); },
        openDailyModal(dateStr) { /* ... unchanged ... */ },
        refreshDailyModal(dateStr) { /* ... unchanged ... */ },
        renderMiniCard(rec) { /* ... modified to add export button ... */ },
        openModal(recordId = null, prefillDate = null) { /* ... unchanged ... */ },
        updateResultArea(mode, record = null, prefillPlayers = false) { /* ... unchanged ... */ },
        startSpeechRecognition(targetInput, targetButton) { /* ... unchanged ... */ },
        saveRecord(recordId) { /* ... unchanged ... */ },
        deleteRecord(id, callback) { /* ... unchanged ... */ },
        formatCurrency(num) { /* ... unchanged ... */ },
        closeModal(modalId, fullRender = true) { /* ... changed for better handling ... */ },
        // --- ICS Export ---
        exportToICS(recordId) {
            const rec = this.state.records.find(r => r.id === recordId);
            if (!rec) return;

            const formatDT = (date, time) => `${date.replace(/-/g, '')}T${time.replace(/:/g, '')}00`;
            const startDate = formatDT(rec.date, rec.startTime);
            const endDate = formatDT(rec.date, rec.endTime);

            let description = `底/台: ${rec.base}/${rec.points}\\n\\n`;
            if (rec.mode === 'chips') {
                description += '四人戰績:\\n' + rec.players.map(p => `${p.name}: ${this.formatCurrency(p.score)}`).join('\\n');
            } else {
                description += `個人戰績: ${this.formatCurrency(rec.myScore)}`;
            }

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'BEGIN:VEVENT',
                `UID:${rec.id}@mahjong.app`,
                `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '').slice(0, 15)}Z`,
                `DTSTART:${startDate}`,
                `DTEND:${endDate}`,
                `SUMMARY:麻將牌局 @ ${rec.location || '未記錄地點'}`,
                `LOCATION:${rec.location || ''}`,
                `DESCRIPTION:${description}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mahjong-${rec.date}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },
        exportMonthToICS() {
            const year = this.state.calendarDate.getFullYear();
            const month = this.state.calendarDate.getMonth() + 1;
            const monthlyRecords = this.state.records.filter(r => r.date.startsWith(`${year}-${String(month).padStart(2, '0')}`));

            if (monthlyRecords.length === 0) {
                alert('本月沒有任何紀錄可匯出。');
                return;
            }

            const icsEvents = monthlyRecords.map(rec => {
                const formatDT = (date, time) => `${date.replace(/-/g, '')}T${time.replace(/:/g, '')}00`;
                const startDate = formatDT(rec.date, rec.startTime);
                const endDate = formatDT(rec.date, rec.endTime);

                let description = `底/台: ${rec.base}/${rec.points}\\n\\n`;
                if (rec.mode === 'chips') {
                    description += '四人戰績:\\n' + rec.players.map(p => `${p.name}: ${this.formatCurrency(p.score)}`).join('\\n');
                } else {
                    description += `個人戰績: ${this.formatCurrency(rec.myScore)}`;
                }

                return [
                    'BEGIN:VEVENT',
                    `UID:${rec.id}@mahjong.app`,
                    `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '').slice(0, 15)}Z`,
                    `DTSTART:${startDate}`,
                    `DTEND:${endDate}`,
                    `SUMMARY:麻將牌局 @ ${rec.location || '未記錄地點'}`,
                    `LOCATION:${rec.location || ''}`,
                    `DESCRIPTION:${description}`,
                    'END:VEVENT'
                ].join('\r\n');
            }).join('\r\n');

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                icsEvents,
                'END:VCALENDAR'
            ].join('\r\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mahjong-${year}-${String(month).padStart(2, '0')}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },
    };

    // --- Mocking unchanged functions for response brevity ---
    const unchangedFunctions = {
        renderPersonalStats: function(containerElement) { const getMyStats = (records) => {const playerName = this.state.mainPlayerName; let totalScore = 0, wins = 0, games = 0, biggestWin = 0, biggestLoss = 0; records.forEach(rec => { let playerScore = 0; let isParticipant = false; if (rec.mode === 'chips') { const player = rec.players.find(p => p.name === playerName); if (player) { playerScore = player.score; isParticipant = true; } } else if (playerName === "我") { playerScore = rec.myScore; isParticipant = true; } if (isParticipant) { totalScore += playerScore; games++; if (playerScore > 0) wins++; if (playerScore > biggestWin) biggestWin = playerScore; if (playerScore < biggestLoss) biggestLoss = playerScore; } }); const winRate = games > 0 ? Math.round((wins / games) * 100) : 0; return { score: totalScore, winRate, biggestWin, biggestLoss };}; const monthlyRecords = this.state.records.filter(r => r.date.startsWith(`${this.state.calendarDate.getFullYear()}-${String(this.state.calendarDate.getMonth() + 1).padStart(2, '0')}`)); const yearlyRecords = this.state.records.filter(r => r.date.startsWith(`${this.state.calendarDate.getFullYear()}`)); const myMonthly = getMyStats(monthlyRecords); const myYearly = getMyStats(yearlyRecords); const myTotal = getMyStats(this.state.records); const renderStatCard = (label, value, subtext = '') => { let valueClass = 'text-gray-800'; if (typeof value === 'number' && subtext === '') { valueClass = value >= 0 ? 'score-positive' : 'score-negative'; value = this.formatCurrency(value); } else if (subtext !== '') { value = `${value}<span class="text-base font-medium text-gray-500 ml-1">${subtext}</span>` } return `<div class="stat-card p-4 rounded-lg shadow-sm"><p class="text-sm font-semibold text-gray-600">${label}</p><p class="text-xl font-bold font-mono mt-1 ${valueClass}">${value}</p></div>`; }; containerElement.innerHTML = renderStatCard('本月輸贏', myMonthly.score) + renderStatCard('本月勝率', myMonthly.winRate, '%') + renderStatCard('本年輸贏', myYearly.score) + renderStatCard('生涯總計', myTotal.score) + renderStatCard('最大單場勝利', myTotal.biggestWin) + renderStatCard('最大單場敗北', myTotal.biggestLoss);},
        renderMonthlyChart: function(canvasElement) { if (this.chartInstance) { this.chartInstance.destroy(); } const monthlyRecords = this.state.records.filter(r => r.date.startsWith(`${this.state.calendarDate.getFullYear()}-${String(this.state.calendarDate.getMonth() + 1).padStart(2, '0')}`)); const stats = {}; this.state.dashboardSelectedPlayers.forEach(p => stats[p] = 0); monthlyRecords.forEach(rec => { if (rec.mode === 'chips') { rec.players.forEach(p => { if (stats.hasOwnProperty(p.name)) stats[p.name] += p.score; }); } else { if (stats.hasOwnProperty("我")) stats["我"] += rec.myScore; } }); const sortedPlayers = Object.entries(stats).sort((a, b) => b[1] - a[1]); const labels = sortedPlayers.map(p => p[0]); const data = sortedPlayers.map(p => p[1]); const ctx = canvasElement.getContext('2d'); this.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: '當月輸贏', data: data, backgroundColor: data.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'), borderColor: data.map(v => v >= 0 ? 'rgba(22, 163, 74, 1)' : 'rgba(220, 38, 38, 1)'), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: `${this.state.calendarDate.getMonth() + 1}月 玩家戰績比較` } }, scales: { y: { beginAtZero: true, grid: { color: '#e5e7eb' } }, x: { grid: { display: false } } } } }); },
        renderListView: function() { const list = this.elements.listView; if (this.state.records.length === 0) { list.innerHTML = `<div class="text-center text-gray-500 py-16 px-6 bg-white rounded-xl shadow-md"><h3 class="mt-2 text-lg font-medium text-gray-900">尚無牌局紀錄</h3><p class="mt-1 text-sm text-gray-500">點擊右上角的 "新增牌局" 開始記錄吧！</p></div>`; return; } list.innerHTML = this.state.records.map(rec => this.renderCard(rec)).join(''); },
        renderCard: function(rec) { const locationHtml = rec.location ? `<div class="flex items-center gap-1 text-sm text-gray-500 mt-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span>${rec.location}</span></div>` : ''; const modeTag = rec.mode === 'chips' ? `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full">籌碼制</span>` : `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-1 rounded-full">現金制</span>`; let resultHtml = ''; if (rec.mode === 'chips') { resultHtml = `<h4 class="font-semibold text-gray-700 mb-2">四人戰績</h4><div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">${rec.players.map(p => `<div class="flex justify-between items-center"><span class="text-gray-600 truncate pr-2">${p.name}：</span><span class="font-mono font-medium ${p.score >= 0 ? 'score-positive' : 'score-negative'}">${this.formatCurrency(p.score)}</span></div>`).join('')}</div>`; } else { resultHtml = `<h4 class="font-semibold text-gray-700 mb-2">個人戰績</h4><div class="flex justify-between items-center"><span class="text-gray-600">我的輸贏：</span><span class="text-2xl font-mono font-bold ${rec.myScore >= 0 ? 'score-positive' : 'score-negative'}">${this.formatCurrency(rec.myScore)}</span></div>`; } return `<div class="bg-white rounded-xl shadow-lg p-5 transition-shadow hover:shadow-xl"><div class="flex justify-between items-start pb-3 border-b border-gray-200"><div><p class="font-bold text-xl text-gray-800">${rec.date}</p><p class="text-sm text-gray-500">${rec.startTime} ~ ${rec.endTime}</p>${locationHtml}</div><div class="flex flex-col items-end gap-3"><div class="flex items-center gap-3"><div class="text-center"><p class="text-xs text-gray-500">底/台</p><p class="font-semibold text-indigo-600">${rec.base}/${rec.points}</p></div>${modeTag}</div><div class="flex gap-1"><button data-id="${rec.id}" class="export-btn p-2 text-gray-400 hover:text-green-600 rounded-full hover:bg-gray-100 transition" title="匯出至行事曆"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button><button data-id="${rec.id}" class="edit-btn p-2 text-gray-400 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition" title="編輯"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button data-id="${rec.id}" class="delete-btn p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-gray-100 transition" title="刪除"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div></div><div class="pt-4">${resultHtml}</div></div>`; },
        renderCalendar: function() { const date = this.state.calendarDate; const year = date.getFullYear(); const month = date.getMonth(); this.elements.monthYearDisplay.textContent = `${year}年 ${month + 1}月`; this.elements.calendarGrid.innerHTML = ''; const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const todayStr = new Date().toISOString().slice(0, 10); for (let i = 0; i < firstDay; i++) { this.elements.calendarGrid.innerHTML += `<div class="day-cell other-month border-r border-t border-gray-200"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const hasRecord = this.state.records.some(r => r.date === dateStr); const isToday = dateStr === todayStr; const cell = document.createElement('div'); cell.className = `day-cell relative p-1 border-r border-t border-gray-200 transition ${hasRecord ? 'has-record' : ''} ${isToday ? 'today' : ''}`; cell.dataset.date = dateStr; cell.innerHTML = `<span class="day-number text-sm font-semibold">${day}</span> ${hasRecord ? '<div class="absolute bottom-2 right-2 w-2 h-2 bg-indigo-500 rounded-full"></div>' : ''}`; this.elements.calendarGrid.appendChild(cell); } },
        openDailyModal: function(dateStr) { const dailyRecords = this.state.records.filter(r => r.date === dateStr); let recordsHtml = dailyRecords.length > 0 ? dailyRecords.map(rec => this.renderMiniCard(rec)).join('') : `<p class="text-center text-sm text-gray-500 py-8">本日無紀錄。</p>`; const modalHTML = `<div id="daily-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="bg-white rounded-xl shadow-xl w-full max-w-lg modal-content max-h-[90vh] flex flex-col"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">${dateStr} 的牌局</h3><button id="close-daily-modal-btn" class="p-2 text-gray-400 hover:text-gray-700 rounded-full text-2xl leading-none">&times;</button></div><div class="p-6 flex-grow overflow-y-auto space-y-4" id="daily-modal-list">${recordsHtml}</div><div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl border-t"><button id="add-from-daily-modal-btn" class="w-full btn-primary font-bold py-3 px-5 rounded-lg flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span>為此日新增牌局</span></button></div></div></div>`; this.elements.modalContainer.innerHTML = modalHTML; const modal = document.getElementById('daily-modal'); requestAnimationFrame(() => modal.classList.add('modal-open')); document.getElementById('close-daily-modal-btn').onclick = () => this.closeModal('daily-modal'); document.getElementById('add-from-daily-modal-btn').onclick = () => { this.closeModal('daily-modal', false); this.openModal(null, dateStr); }; },
        refreshDailyModal: function(dateStr) { const dailyRecords = this.state.records.filter(r => r.date === dateStr); const listElement = document.getElementById('daily-modal-list'); if (listElement) { listElement.innerHTML = dailyRecords.length > 0 ? dailyRecords.map(rec => this.renderMiniCard(rec)).join('') : `<p class="text-center text-sm text-gray-500 py-8">本日無紀錄。</p>`; } },
        renderMiniCard: function(rec) { const resultHtml = rec.mode === 'chips' ? `<div class="text-xs grid grid-cols-2 gap-x-2">${rec.players.map(p => `<div class="flex justify-between"><span class="truncate pr-1">${p.name}</span><span class="font-mono ${p.score >= 0 ? 'score-positive' : 'score-negative'}">${this.formatCurrency(p.score)}</span></div>`).join('')}</div>` : `<div class="text-sm flex justify-between"><span>我的戰績</span><span class="font-mono font-bold ${rec.myScore >= 0 ? 'score-positive' : 'score-negative'}">${this.formatCurrency(rec.myScore)}</span></div>`; return `<div class="bg-gray-50 p-3 rounded-lg text-gray-700"><div class="flex justify-between items-center mb-2"><p class="text-xs font-semibold">${rec.startTime} - ${rec.endTime} @ ${rec.location || '未記錄地點'}</p><div class="flex gap-1"><button data-id="${rec.id}" class="export-btn p-1 text-gray-400 hover:text-green-600" title="匯出至行事曆"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button><button data-id="${rec.id}" class="edit-btn p-1 text-gray-400 hover:text-indigo-600" title="編輯"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button data-id="${rec.id}" class="delete-btn p-1 text-gray-400 hover:text-red-600" title="刪除"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div>${resultHtml}</div>`; },
        openModal: function(recordId = null, prefillDate = null) { const isEditing = recordId !== null; let record = isEditing ? this.state.records.find(r => r.id === recordId) : {}; if (prefillDate && !isEditing) record.date = prefillDate; const now = new Date(); const timeToStr = (d) => d.toTimeString().slice(0, 5); const modalHTML = `<div id="session-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="bg-white rounded-xl shadow-xl w-full max-w-2xl modal-content max-h-[90vh] flex flex-col"><div class="p-5 border-b"><h3 class="text-xl font-semibold">${isEditing ? '編輯牌局' : '新增牌局'}</h3></div><div class="p-6 flex-grow overflow-y-auto space-y-6"><div class="grid grid-cols-2 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">日期</label><input type="date" id="rec-date" class="mt-1 p-2 border rounded-md w-full"></div><div><label class="block text-sm font-medium text-gray-700">開始時間</label><input type="time" id="rec-start-time" class="mt-1 p-2 border rounded-md w-full"></div><div><label class="block text-sm font-medium text-gray-700">結束時間</label><input type="time" id="rec-end-time" class="mt-1 p-2 border rounded-md w-full"></div><div class="col-span-2 md:col-span-1"><label class="block text-sm font-medium text-gray-700">地點</label><input type="text" id="rec-location" placeholder="例：板橋王董家" class="mt-1 p-2 border rounded-md w-full"></div><div class="grid grid-cols-2 gap-2 col-span-2 md:col-span-2"><div><label class="block text-sm font-medium text-gray-700">底</label><input type="number" id="rec-base" class="mt-1 p-2 border rounded-md w-full"></div><div><label class="block text-sm font-medium text-gray-700">台</label><input type="number" id="rec-points" class="mt-1 p-2 border rounded-md w-full"></div></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">計分方式</label><div class="flex gap-4"><label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer flex-1"><input type="radio" name="mode" value="chips" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500"> 籌碼制 (記錄四人)</label><label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer flex-1"><input type="radio" name="mode" value="cash" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500"> 現金制 (僅記個人)</label></div></div><div id="result-area"></div></div><div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl border-t"><button id="cancel-btn" class="py-2 px-6 bg-white border border-gray-300 rounded-lg font-medium hover:bg-gray-50">取消</button><button id="save-btn" class="py-2 px-6 btn-primary rounded-lg font-medium">儲存</button></div></div></div>`; this.elements.modalContainer.innerHTML = modalHTML; document.getElementById('rec-date').value = record?.date || now.toISOString().slice(0, 10); document.getElementById('rec-start-time').value = record?.startTime || timeToStr(new Date(now.getTime() - 10800000)); document.getElementById('rec-end-time').value = record?.endTime || timeToStr(now); document.getElementById('rec-location').value = record?.location || ''; document.getElementById('rec-base').value = record?.base || ''; document.getElementById('rec-points').value = record?.points || ''; const mode = record?.mode || 'chips'; document.querySelector(`input[name="mode"][value="${mode}"]`).checked = true; this.updateResultArea(mode, record, !isEditing); document.getElementById('session-modal').classList.add('modal-open'); document.getElementById('cancel-btn').onclick = () => this.closeModal('session-modal'); document.getElementById('save-btn').onclick = () => this.saveRecord(recordId); document.querySelectorAll('input[name="mode"]').forEach(radio => { radio.onchange = (e) => this.updateResultArea(e.target.value, record, !isEditing); }); },
        updateResultArea: function(mode, record = null, prefillPlayers = false) { const area = document.getElementById('result-area'); if (mode === 'chips') { let playerFields = ''; for (let i = 0; i < 4; i++) { const defaultName = (prefillPlayers && i === 0) ? this.state.mainPlayerName : ''; const name = record?.players?.[i]?.name || defaultName; const score = record?.players?.[i]?.score === undefined ? '' : record.players[i].score; playerFields += `<div class="flex items-center gap-2"><input type="text" id="player-name-${i}" name="player-name" placeholder="玩家 ${i+1}" value="${name}" class="p-2 border rounded-md w-full"><button class="speech-btn p-2 text-gray-500 hover:text-indigo-600" data-target="player-name-${i}" title="語音輸入"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></button><input type="number" name="player-score" placeholder="輸贏" value="${score}" class="p-2 border rounded-md w-full"></div>`; } area.innerHTML = `<label class="block text-sm font-medium text-gray-700">四人輸贏</label><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">${playerFields}</div><p id="score-sum-error" class="text-red-500 text-sm text-center mt-2 hidden">四人輸贏總和必須為 0</p>`; } else { area.innerHTML = `<label class="block text-sm font-medium text-gray-700">我的輸贏</label><input type="number" id="my-score" placeholder="輸入個人輸贏金額" value="${record?.myScore || ''}" class="mt-1 p-2 border rounded-md w-full">`; } document.querySelectorAll('.speech-btn').forEach(btn => { btn.onclick = (e) => { e.preventDefault(); if (!recognition) { alert('您的瀏覽器不支援語音輸入功能。'); return; } this.startSpeechRecognition(document.getElementById(btn.dataset.target), btn); }; }); },
        startSpeechRecognition: function(targetInput, targetButton) { targetButton.classList.add('recording'); recognition.start(); recognition.onresult = (event) => { targetInput.value = event.results[0][0].transcript; }; recognition.onspeechend = () => { recognition.stop(); }; recognition.onerror = (event) => { console.error('Speech recognition error', event.error); }; recognition.onend = () => { targetButton.classList.remove('recording'); }; },
        saveRecord: function(recordId) { const newRecord = { id: recordId || Date.now().toString(), date: document.getElementById('rec-date').value, startTime: document.getElementById('rec-start-time').value, endTime: document.getElementById('rec-end-time').value, location: document.getElementById('rec-location').value.trim(), base: document.getElementById('rec-base').value, points: document.getElementById('rec-points').value, mode: document.querySelector('input[name="mode"]:checked').value, }; if (!newRecord.date || !newRecord.startTime || !newRecord.endTime) { alert('請填寫日期與時間！'); return; } if (newRecord.mode === 'chips') { const names = document.querySelectorAll('input[name="player-name"]'); const scores = document.querySelectorAll('input[name="player-score"]'); let scoreSum = 0; newRecord.players = []; for (let i=0; i<4; i++) { const name = names[i].value.trim(); const score = parseInt(scores[i].value, 10) || 0; if (!name) { alert(`請輸入玩家 ${i+1} 的名稱`); return; } newRecord.players.push({ name, score }); scoreSum += score; } if (scoreSum !== 0) { document.getElementById('score-sum-error').classList.remove('hidden'); return; } } else { newRecord.myScore = parseInt(document.getElementById('my-score').value, 10) || 0; } if (recordId) { const index = this.state.records.findIndex(r => r.id === recordId); this.state.records[index] = newRecord; } else { this.state.records.push(newRecord); } this.saveState(); this.closeModal('session-modal'); },
        deleteRecord: function(id, callback) { if (confirm('您確定要刪除這場牌局紀錄嗎？')) { this.state.records = this.state.records.filter(r => r.id !== id); this.saveState(); if (callback) { callback(); } this.render(); } },
        formatCurrency: function(num) { if (typeof num !== 'number') return num; const sign = num > 0 ? '+' : ''; return sign + num.toLocaleString(); },
        closeModal: function(modalId, fullRender = true) { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('modal-open'); setTimeout(() => { if (document.querySelectorAll('.modal-backdrop').length <= 1) this.elements.modalContainer.innerHTML = ''; }, 300); } if (fullRender) { this.render(); } },
    };
    Object.assign(app, { ...unchangedFunctions, getMyStats: unchangedFunctions.getMyStats });
    
    app.init();
});
</script>

</body>
</html>

